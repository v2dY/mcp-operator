# ADR-001: Kubernetes Operator for MCP Server Management

## Status
- **Status:** Accepted
- **Date:** 2025-07-13
- **Authors:** v2dY Development Team
- **Reviewers:** Technical Architecture Committee

## Context

We need to solve the problem of managing Model Context Protocol (MCP) servers at scale in Kubernetes environments. Currently, deploying and managing MCP servers requires manual configuration, lacks standardization, and doesn't provide automated lifecycle management.

### Business Requirements
- **Standardized MCP Deployment:** Consistent way to deploy MCP servers across environments
- **Automated Lifecycle Management:** Create, update, delete, and scale MCP servers declaratively
- **Multi-tenant Support:** Isolate MCP servers per namespace/team
- **Integration Ready:** Easy integration with AI agents and external services
- **Production Ready:** Monitoring, logging, and health checks out of the box

### Technical Constraints
- Must run on Kubernetes v1.11.3+
- Support for standard Kubernetes patterns (CRDs, Controllers, RBAC)
- Compatible with existing CI/CD pipelines
- Support for both Helm and raw YAML deployments
- Must follow Kubebuilder best practices

### Non-Functional Requirements
- **Reliability:** Self-healing and automatic reconciliation
- **Scalability:** Handle hundreds of MCP server instances
- **Security:** RBAC integration and secure defaults
- **Observability:** Comprehensive metrics and logging
- **Maintainability:** Clear APIs and documentation

## Decision

We adopt the **Kubernetes Operator Pattern** to manage MCP servers as custom resources, providing declarative APIs for MCP server lifecycle management.

### Core Architecture Components

#### 1. Custom Resource Definitions (CRDs)
- **MCPServer CRD:** Defines individual MCP server instances
- **MCPPool CRD:** (Future) Manages groups of related MCP servers
- **Declarative Configuration:** YAML-based server definitions

#### 2. Controller Manager
- **MCPServer Controller:** Reconciles MCPServer resources
- **Event-driven Architecture:** Watches for resource changes
- **Automatic Reconciliation:** Ensures desired state matches actual state
- **Error Handling:** Robust error recovery and status reporting

#### 3. Deployment Patterns
- **Helm Chart Distribution:** `oci://ghcr.io/v2dy/project/chart/helm:0.1.0`
- **Raw YAML Support:** Direct kubectl apply from manifests
- **GitOps Integration:** Compatible with Flux, ArgoCD, etc.

#### 4. MCP Server Management
- **Automated Pod Creation:** Creates pods for MCP server workloads
- **Service Discovery:** Automatic service and ingress configuration
- **Health Monitoring:** Readiness and liveness probes
- **Resource Management:** CPU/memory limits and requests

### Technology Stack

| Component | Technology | Purpose |
|-----------|------------|---------|
| Operator Framework | Kubebuilder | Controller scaffolding |
| Language | Go v1.24.0+ | Controller implementation |
| Container Runtime | Docker 17.03+ | Container builds |
| Orchestration | Kubernetes v1.11.3+ | Platform foundation |
| Packaging | Helm | Chart distribution |
| Registry | GHCR | Container and chart storage |

### MCPServer CRD Specification

```yaml
apiVersion: mcp.v2dy.io/v1
kind: MCPServer
metadata:
  name: example-mcp-server
  namespace: default
spec:
  image: "mcp/example-server:latest"
  port: 3000
  protocol: "http" # or "stdio"
  resources:
    requests:
      memory: "64Mi"
      cpu: "250m"
    limits:
      memory: "128Mi"
      cpu: "500m"
  replicas: 1
  env:
    - name: API_KEY
      valueFrom:
        secretKeyRef:
          name: mcp-secrets
          key: api-key
status:
  phase: "Running"
  conditions:
    - type: "Ready"
      status: "True"
  replicas: 1
  readyReplicas: 1
```

### Operator Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   MCPServer     │  │   MCPServer     │  │  MCPServer   │ │
│  │   Custom        │  │   Custom        │  │  Custom      │ │
│  │   Resource      │  │   Resource      │  │  Resource    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│            │                   │                   │         │
│            ▼                   ▼                   ▼         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              MCP Operator Controller                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   Watch     │  │  Reconcile  │  │   Update        │ │ │
│  │  │   Events    │  │   State     │  │   Status        │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│            │                   │                   │         │
│            ▼                   ▼                   ▼         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Pod + Service │  │   Pod + Service │  │ Pod + Service│ │
│  │   (MCP Server   │  │   (MCP Server   │  │ (MCP Server  │ │
│  │    Workload)    │  │    Workload)    │  │   Workload)  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Controller Logic Flow

```
User applies MCPServer YAML
         ↓
Controller watches MCPServer resources
         ↓
Reconcile loop triggered
         ↓
┌─── Check if Pod exists ────┐
│                           │
│ NO                        │ YES
│                           │
▼                           ▼
Create Pod + Service    Update if needed
         ↓                   │
Update MCPServer status     │
         ↓                   │
         └───────────────────┘
                 ↓
         Wait for next event
```

## Alternatives Considered

### Alternative 1: Helm Charts Only
- **Description:** Provide only Helm charts for MCP server deployment
- **Pros:** Simple to implement, familiar to users
- **Cons:** No automated lifecycle management, manual scaling, no standardized APIs
- **Why rejected:** Doesn't solve automation and standardization requirements

### Alternative 2: Custom Deployment Scripts
- **Description:** Bash/Python scripts for MCP server management
- **Pros:** Quick to develop, full control over deployment logic
- **Cons:** Not Kubernetes-native, poor integration with K8s tooling, maintenance burden
- **Why rejected:** Doesn't leverage Kubernetes patterns and ecosystem

### Alternative 3: Existing Generic Operators
- **Description:** Use operators like Crossplane or Operator SDK templates
- **Pros:** Less development effort, proven patterns
- **Cons:** Generic solutions lack MCP-specific features, over-engineered for simple use case
- **Why rejected:** MCP servers have specific requirements that generic operators don't address

### Alternative 4: Manual kubectl apply
- **Description:** Users manually create deployments and services
- **Pros:** Simple, no additional tooling required
- **Cons:** Error-prone, no standardization, poor user experience
- **Why rejected:** Doesn't scale and creates operational burden

## Consequences

### Positive Consequences
- **Standardization:** Consistent MCP server deployment patterns across teams
- **Automation:** Declarative lifecycle management reduces manual operations
- **Kubernetes Native:** Leverages Kubernetes APIs and tooling ecosystem
- **Scalability:** Controller pattern handles hundreds of MCP server instances
- **Extensibility:** CRD spec can evolve to support new MCP features
- **Integration:** Works seamlessly with GitOps workflows and CI/CD pipelines
- **Developer Experience:** Simple YAML configuration for complex deployments

### Negative Consequences
- **Learning Curve:** Teams need to understand Kubernetes operators and CRDs
- **Operational Complexity:** Requires understanding of controller reconciliation
- **Development Overhead:** Operator development requires Go expertise
- **Debugging Complexity:** Controller logs and events needed for troubleshooting

### Neutral Consequences
- **Kubernetes Dependency:** Requires Kubernetes cluster for operation
- **Go Language Requirement:** Operator development tied to Go ecosystem
- **Version Management:** Need to maintain compatibility across Kubernetes versions

## Decision Criteria

### Technical Criteria
- **Kubernetes Native:** ✅ Uses standard CRDs and controller patterns
- **Scalability:** ✅ Controller pattern scales to hundreds of resources
- **Maintainability:** ✅ Kubebuilder provides standard scaffolding
- **Extensibility:** ✅ CRD spec allows for future feature additions
- **Integration:** ✅ Works with existing Kubernetes tooling

### Business Criteria
- **Time to Value:** ✅ Reduces MCP server deployment complexity
- **Operational Efficiency:** ✅ Automated reconciliation reduces manual work
- **Standardization:** ✅ Consistent deployment patterns across environments
- **Team Productivity:** ✅ Declarative APIs improve developer experience

### Risk Mitigation
- **Complexity Risk:** Mitigated by following Kubebuilder best practices
- **Maintenance Risk:** Mitigated by using standard operator patterns
- **Adoption Risk:** Mitigated by providing both Helm and raw YAML options

## Implementation Details

### Development Stack
```bash
# Prerequisites
go version v1.24.0+
docker version 17.03+
kubectl version v1.11.3+

# Development workflow
make docker-build docker-push IMG=ghcr.io/v2dy/operator:tag
make install                    # Install CRDs
make deploy IMG=ghcr.io/v2dy/operator:tag
kubectl apply -k config/samples/ # Test deployment
```

### Distribution Methods

#### Method 1: Helm Chart (Recommended)
```bash
helm install v2dy-mcp oci://ghcr.io/v2dy/project/chart/helm:0.1.0
kubectl apply -f config/samples/mcp_v1_mcpserver.yaml
```

#### Method 2: Raw YAML
```bash
kubectl apply -f https://raw.githubusercontent.com/v2dy/project/main/dist/install.yaml
```

### Sample MCPServer Usage
```yaml
# Example: SendGrid MCP Server
apiVersion: mcp.v2dy.io/v1
kind: MCPServer
metadata:
  name: sendgrid-mcp
  namespace: default
spec:
  image: "ghcr.io/v2dy/sendgrid-mcp:latest"
  port: 3001
  protocol: "http"
  env:
    - name: BEARER_TOKEN_BEARERAUTH
      valueFrom:
        secretKeyRef:
          name: sendgrid-secrets
          key: bearer-token
```

## Success Metrics

### Technical Metrics
- **Deployment Time:** < 30 seconds from YAML apply to running MCP server
- **Reconciliation Performance:** < 5 seconds for state convergence
- **Resource Efficiency:** < 50MB memory footprint for operator
- **API Reliability:** 99.9% successful reconciliation rate

### Business Metrics
- **Developer Productivity:** 80% reduction in MCP server setup time
- **Operational Efficiency:** 90% fewer manual deployment interventions
- **Adoption Rate:** Used by 100% of teams deploying MCP servers

## Future Enhancements

### Phase 1: Core Operator (Current)
- [x] MCPServer CRD implementation
- [x] Basic controller reconciliation
- [x] Helm chart packaging
- [x] GHCR distribution

### Phase 2: Advanced Features (Planned)
- [ ] MCPPool CRD for server grouping
- [ ] Horizontal Pod Autoscaler integration
- [ ] Custom metrics and monitoring
- [ ] Webhook validation

### Phase 3: Enterprise Features (Future)
- [ ] Multi-cluster support
- [ ] Advanced RBAC policies
- [ ] Backup and restore capabilities
- [ ] Cost optimization features

## Related Decisions
- ADR-002: [Planned] MCP Protocol Standards and Best Practices
- ADR-003: [Planned] Security and RBAC Architecture for MCP Servers
- ADR-004: [Planned] Monitoring and Observability Strategy

## Notes
- Operator follows Kubebuilder best practices and patterns
- CRD design allows for future extensibility without breaking changes
- Helm chart provides easy installation and configuration management
- Compatible with GitOps workflows and CI/CD automation
- Designed for multi-tenant Kubernetes environments

---

## Metadata
- **ID:** ADR-001
- **Last Updated:** 2025-07-13
- **Version:** 1.0
- **Tags:** [kubernetes, operator, mcp, crd, kubebuilder, automation]
- **Repository:** https://github.com/v2dY/project
- **Controller Code:** internal/controller/mcpserver_controller.go