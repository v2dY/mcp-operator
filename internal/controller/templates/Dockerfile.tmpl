FROM node:22-slim

# Build arguments

WORKDIR /app

# Install system dependencies
RUN apt update && apt install -y wget

# Install openapi-mcp-generator globally
RUN npm i -g https://github.com/sarco3t/openapi-mcp-generator/releases/download/v3.1.6/openapi-mcp-generator-3.1.6.tgz

# Create non-root user
RUN groupadd -r appuser && useradd -r -g appuser -u 1001 appuser

# Create npm cache directory for the user
RUN mkdir -p /tmp/.npm && chown -R appuser:appuser /tmp/.npm

# Copy package.json
COPY package*.json ./

# Copy entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

RUN wget {{.OpenAPIUrl}} -O /tmp/openapi
# Generate MCP server code
RUN if [ -n "{{.BasePath}}" ]; then \
      openapi-mcp-generator --input /tmp/openapi -o . --transport=web --force --port=3001 -b "{{.BasePath}}"; \
    else \
      openapi-mcp-generator --input /tmp/openapi -o . --transport=web --force --port=3001; \
    fi

# Install dependencies and build
RUN npm install && npm run build

# Change ownership of /app to the non-root user
RUN chown -R appuser:appuser /app

# Switch to non-root user
USER appuser

# Configure npm to use /tmp for cache
ENV NPM_CONFIG_CACHE=/tmp/.npm

EXPOSE 3001

ENTRYPOINT ["/entrypoint.sh"]